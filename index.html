<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EquiVoice - Bias Detection with Theory of Mind</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --bg-light: #f4f7fa;
      --bg-dark: #2c3e50;
      --text-light: #333;
      --text-dark: #ecf0f1;
      --primary: #3498db;
      --secondary: #e74c3c;
      --accent: #2ecc71;
      --stress-low: #3498db80;
      --stress-mid: #f1c40f80;
      --stress-high: #e74c3c80;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
      background: linear-gradient(135deg, var(--bg-light), #e8eef3);
      color: var(--text-light);
      transition: all 0.3s ease;
      position: relative;
    }
    body.dark {
      background: linear-gradient(135deg, var(--bg-dark), #34495e);
      color: var(--text-dark);
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 20px;
      color: var(--primary);
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }
    .section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }
    body.dark .section {
      background: #34495e;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .section:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    button {
      padding: 10px 20px;
      background: linear-gradient(45deg, var(--primary), #2980b9);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background: linear-gradient(45deg, #2980b9, var(--primary));
      transform: scale(1.05);
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }
    button i { margin-right: 5px; }
    textarea, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
      background: #fff;
      color: var(--text-light);
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    textarea#paste-input {
      height: 200px;
      resize: vertical;
      min-height: 100px;
      max-height: 400px;
    }
    textarea:focus, input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 5px var(--primary);
      outline: none;
    }
    body.dark textarea, body.dark input {
      background: #3d566e;
      border-color: #5d6d7e;
      color: var(--text-dark);
    }
    body.dark textarea:focus, body.dark input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 5px var(--accent);
    }
    .flag { color: var(--secondary); font-style: italic; }
    .tip { color: var(--accent); font-style: italic; }
    .summary { padding: 15px; border-radius: 5px; background: #ecf0f1; }
    body.dark .summary { background: #3d566e; }
    .transcript-line { 
      margin: 5px 0; 
      padding: 8px; 
      border-bottom: 1px solid #eee; 
      transition: background 0.3s, transform 0.2s;
      cursor: pointer;
      border-radius: 3px;
    }
    .transcript-line.stress-low { background: var(--stress-low); }
    .transcript-line.stress-mid { background: var(--stress-mid); }
    .transcript-line.stress-high { background: var(--stress-high); }
    .transcript-line:hover { 
      background: #ddd; 
      transform: translateX(5px);
    }
    body.dark .transcript-line { border-color: #5d6d7e; }
    body.dark .transcript-line:hover { background: #4a6278; }
    #keyword-cloud span {
      display: inline-block;
      margin: 5px;
      padding: 6px 12px;
      background: linear-gradient(45deg, var(--primary), var(--accent));
      color: white;
      border-radius: 20px;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #keyword-cloud span:hover { transform: scale(1.1); }
    #collab-radar { max-width: 350px; margin: 20px auto; }
    .settings { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 15px; 
      background: #f9f9f9; 
      padding: 15px; 
      border-radius: 5px; 
    }
    body.dark .settings { background: #3d566e; }
    #theme-toggle { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      background: linear-gradient(45deg, #34495e, #2c3e50); 
    }
    body.dark #theme-toggle { background: linear-gradient(45deg, var(--accent), #27ae60); }
    .error-message { color: var(--secondary); display: none; margin-top: 10px; }
    #char-counter {
      font-size: 0.9em;
      color: var(--text-light);
      margin-top: 5px;
      text-align: right;
    }
    body.dark #char-counter { color: var(--text-dark); }
    @media (max-width: 600px) {
      h1 { font-size: 1.8em; }
      .section { padding: 15px; }
      textarea#paste-input { height: 150px; }
      #collab-radar { max-width: 200px; }
    }
    .guide-content ul {
      list-style-type: none;
      padding-left: 0;
    }
    .guide-content li:before {
      content: "\f058";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      color: var(--primary);
      margin-right: 10px;
    }
    .guide-content h3 {
      margin-top: 15px;
      color: var(--primary);
      display: flex;
      align-items: center;
    }
    .guide-content h3 i { margin-right: 10px; }
    #spinner {
      display: none;
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: var(--primary);
      z-index: 1000;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      pointer-events: none;
    }
    body.dark #spinner { background: rgba(61, 86, 110, 0.9); }
    #spinner::after {
      content: '';
      display: block;
      width: 30px;
      height: 30px;
      border: 4px solid var(--primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .result-header {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 15px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 5px;
      display: flex;
      align-items: center;
    }
    .result-header i { margin-right: 10px; }
    #load-sample-btn {
      background: linear-gradient(45deg, var(--accent), #27ae60);
      margin-bottom: 10px;
    }
    #load-sample-btn:hover {
      background: linear-gradient(45deg, #27ae60, var(--accent));
    }
    #success-message {
      display: none;
      text-align: center;
      color: var(--accent);
      padding: 15px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transition: opacity 0.5s ease;
      font-weight: bold;
    }
    body.dark #success-message { background: rgba(61, 86, 110, 0.95); }
    .progress-bar {
      width: 100%;
      background: #eee;
      border-radius: 5px;
      height: 10px;
      margin: 5px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      transition: width 1s ease-in-out;
    }
    .progress-fill.low { background: var(--primary); }
    .progress-fill.mid { background: #f1c40f; }
    .progress-fill.high { background: var(--secondary); }
  </style>
</head>
<body>
  <button id="theme-toggle"><i class="fas fa-moon"></i> Toggle Dark Mode</button>
  <h1><i class="fas fa-brain"></i> EquiVoice: Bias Detection with Theory of Mind</h1>

  <div class="section" id="guide-section">
    <div class="result-header"><i class="fas fa-book"></i> User Guide</div>
    <div class="guide-content">
      <h3><i class="fas fa-handshake"></i> Welcome to EquiVoice</h3>
      <p>Hello! I’m Azeez Hamzat, and EquiVoice is an experimental platform I’m developing as part of my research. My goal is to explore the best ways to enhance collective intelligence (CI) and minimize biases in heterogeneous group discussions. With features like the MindSync Index powered by Theory of Mind, this tool is a work in progress—your feedback is invaluable as I refine it!</p>
      
      <h3><i class="fas fa-info-circle"></i> How to Use</h3>
      <ul>
        <li>Upload a File: Select a .txt file in "Upload" and click "Analyze File."</li>
        <li>Paste Text: Enter your transcript in "Paste" (resize it!) and click "Analyze Text."</li>
        <li>Try a Sample: Click "Load Sample Transcript" to test with a preloaded meeting transcript.</li>
        <li>Customize Settings: Adjust thresholds or add rules (e.g., "!:warning = Excitement").</li>
        <li>View Results: Check "Collaboration Metrics" for MindSync and "ToM Insights" for tips.</li>
        <li>Export: Click "Export as .txt" in Summary.</li>
      </ul>

      <h3><i class="fas fa-chart-bar"></i> Understanding Results</h3>
      <ul>
        <li>Summary: Key findings, stress count, and MindSync.</li>
        <li>Voice Stress Detector: Stress stats (low/mid/high).</li>
        <li>Keyword Cloud: Frequent words, sized by occurrence.</li>
        <li>Collaboration Metrics: Team Harmony Score + MindSync Index, with a radar chart.</li>
        <li>ToM Insights: Inferred mental states and empathy tips.</li>
        <li>Language & Translation: Detected language with mock translation.</li>
        <li>Historical Comparison: Trends including MindSync.</li>
        <li>Annotated Transcript: Text with flags, tips, stress heatmap, and hover sounds.</li>
      </ul>

      <h3><i class="fas fa-lightbulb"></i> Tips</h3>
      <ul>
        <li>Stress highlights: Blue (low), Yellow (mid), Red (high).</li>
        <li>Hover over stressed lines for sound effects.</li>
        <li>Drag the transcript box—see character count live!</li>
        <li>MindSync high? Team’s in tune. Low? Check ToM Insights.</li>
      </ul>
    </div>
  </div>
  
  <div class="section" id="upload-section">
    <p><i class="fas fa-upload"></i> Upload a meeting transcript (.txt)</p>
    <input type="file" id="upload" accept=".txt">
    <button id="analyze-file-btn"><i class="fas fa-play"></i> Analyze File</button>
    <div id="upload-error" class="error-message"></div>
  </div>
  
  <div class="section" id="paste-section">
    <p><i class="fas fa-paste"></i> Paste your transcript below</p>
    <button id="load-sample-btn"><i class="fas fa-file-alt"></i> Load Sample Transcript</button>
    <textarea id="paste-input" placeholder="e.g., Speaker 1\nYES!!!"></textarea>
    <div id="char-counter">Characters: 0</div>
    <button id="analyze-text-btn"><i class="fas fa-play"></i> Analyze Text</button>
    <div id="paste-error" class="error-message"></div>
  </div>
  
  <div class="section" id="settings-section">
    <p><i class="fas fa-cogs"></i> Customize Detection Thresholds</p>
    <div class="settings">
      <label>Dominance (%): <input type="number" id="dominance-threshold" value="40" min="10" max="90"></label>
      <label>Inclusion (%): <input type="number" id="inclusion-threshold" value="5" min="1" max="20"></label>
      <label>Groupthink (agreements): <input type="number" id="groupthink-threshold" value="3" min="2" max="10"></label>
      <label>Interruptions (lines): <input type="number" id="interrupt-threshold" value="2" min="1" max="10"></label>
    </div>
  </div>

  <div class="section" id="custom-rules-section">
    <p><i class="fas fa-ruler"></i> Custom Bias Rules (e.g., "hate:warning = Negative tone", "!:warning = Excitement")</p>
    <textarea id="custom-rules" placeholder="keyword:severity = message"></textarea>
  </div>
  
  <div id="spinner">Analyzing...</div>

  <div class="section" id="results-section" style="display: none;">
    <div class="result-header"><i class="fas fa-list"></i> Summary</div>
    <div id="summary-content">
      <div id="summary" class="summary"></div>
      <button id="export-btn"><i class="fas fa-download"></i> Export as .txt</button>
    </div>
    
    <div class="result-header"><i class="fas fa-volume-up"></i> Voice Stress Detector</div>
    <div id="stress-content">
      <div id="stress-stats"></div>
    </div>
    
    <div class="result-header"><i class="fas fa-cloud"></i> Keyword Cloud</div>
    <div id="keyword-content">
      <div id="keyword-cloud"></div>
    </div>
    
    <div class="result-header"><i class="fas fa-users"></i> Collaboration Metrics</div>
    <div id="collab-content">
      <div id="collab-metrics"></div>
      <div id="collab-radar"><canvas id="radar-chart"></canvas></div>
    </div>
    
    <div class="result-header"><i class="fas fa-brain"></i> ToM Insights</div>
    <div id="tom-content">
      <div id="tom-insights"></div>
    </div>
    
    <div class="result-header"><i class="fas fa-language"></i> Language & Translation</div>
    <div id="lang-content">
      <div id="language-detection"></div>
    </div>
    
    <div class="result-header"><i class="fas fa-history"></i> Historical Comparison</div>
    <div id="history-content">
      <div id="historical-comparison"></div>
      <canvas id="history-chart" style="max-width: 500px; margin: 20px auto;"></canvas>
    </div>
    
    <div class="result-header"><i class="fas fa-file-alt"></i> Annotated Transcript</div>
    <div id="transcript-content">
      <div id="annotated-transcript"></div>
    </div>
  </div>

  <script src="https://unpkg.com/compromise@14.11.0/builds/compromise.min.js" onerror="console.error('Compromise failed to load'); window.nlp = null;"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" onerror="console.error('Chart.js failed to load'); window.Chart = null;"></script>
  <script src="https://unpkg.com/franc-min@6.2.0/franc-min.js" onerror="console.error('Franc failed to load'); window.franc = null;"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <script>
    let currentAnalysis = null;
    let currentContributions = null;
    let radarChart = null;
    let historyChart = null;

    const stressSounds = {
      low: new Audio('data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA='),
      mid: new Audio('data:audio/wav;base64,UklGRjYAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA='),
      high: new Audio('data:audio/wav;base64,UklGRjwAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQEAAAABAA==')
    };

    const sampleTranscript = `[00:00] Rose: Okay, everyone, let’s get started. We’ve got a tight deadline for this project—two weeks to launch. I need updates from each of you. Tulip, you first.\n[00:10] Tulip: Uh, sure. I’ve been working on the designs, but I need more time! The client keeps changing their mind, and—\n[00:15] Rose: No excuses, we don’t have time! We need those designs by Friday.\n[00:18] Daisy: Wait, but I—\n[00:19] Rose: Hold on, Daisy. Tulip, can you commit to Friday or not?\n[00:22] Tulip: I… I’ll try, but it’s really tough! I’m already stressed out.\n[00:27] Orchid: I get that, Tulip. Maybe we can help? I can talk to the client to finalize their feedback.\n[00:32] Rose: Fine, Orchid, do that. Daisy, what about the dev side?\n[00:36] Daisy: I was trying to say—the backend isn’t ready! If Tulip’s designs aren’t done, I can’t start coding properly.\n[00:42] Rose: Ugh, this is a mess! We can’t keep delaying!\n[00:45] Tulip: I said I’m trying my best!!!\n[00:48] Orchid: Hey, let’s all calm down. Tulip, I hear you’re overwhelmed—let’s figure this out together.\n[00:54] Daisy: Yeah, I agree with Orchid. Maybe we can adjust the timeline a bit?\n[00:58] Rose: No way, the client won’t budge! We need to push harder.\n[01:02] Tulip: You always say that, but you’re not the one doing the work!\n[01:05] Orchid: Rose, maybe we should listen to Tulip—they’re clearly struggling.\n[01:09] Daisy: I can help Tulip with some mockups if that speeds things up.\n[01:13] Rose: Fine, do that. But we’re still aiming for Friday. Let’s wrap up—Orchid, update me on the client tomorrow.`;

    document.getElementById('analyze-file-btn').addEventListener('click', analyzeFile);
    document.getElementById('analyze-text-btn').addEventListener('click', analyzeText);
    document.getElementById('export-btn').addEventListener('click', exportResults);
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      updateChartColors();
    });
    document.getElementById('load-sample-btn').addEventListener('click', loadSampleTranscript);

    const pasteInput = document.getElementById('paste-input');
    const charCounter = document.getElementById('char-counter');
    pasteInput.addEventListener('input', () => {
      charCounter.textContent = `Characters: ${pasteInput.value.length}`;
    });

    function loadSampleTranscript() {
      pasteInput.value = sampleTranscript;
      charCounter.textContent = `Characters: ${sampleTranscript.length}`;
    }

    function showError(elementId, message) {
      const errorDiv = document.getElementById(elementId);
      errorDiv.style.display = 'block';
      errorDiv.textContent = `Error: ${message}`;
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function toggleSpinner(show) {
      const spinner = document.getElementById('spinner');
      const analyzeButtons = [
        document.getElementById('analyze-file-btn'),
        document.getElementById('analyze-text-btn')
      ];
      spinner.style.display = show ? 'block' : 'none';
      analyzeButtons.forEach(btn => btn.disabled = show);
    }

    function showSuccess(message) {
      const successMsg = document.createElement('div');
      successMsg.id = 'success-message';
      successMsg.textContent = message;
      document.body.appendChild(successMsg);
      successMsg.style.display = 'block';
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
      setTimeout(() => {
        successMsg.style.opacity = '0';
        setTimeout(() => successMsg.remove(), 500);
      }, 2000);
    }

    function analyzeFile() {
      const fileInput = document.getElementById('upload');
      const file = fileInput.files[0];
      if (!file) return showError('upload-error', 'Please upload a .txt file.');
      toggleSpinner(true);
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          processTranscript(e.target.result);
        } catch (error) {
          console.error('File processing error:', error);
          showError('upload-error', error.message);
        } finally {
          toggleSpinner(false);
        }
      };
      reader.onerror = () => {
        showError('upload-error', 'Error reading file.');
        toggleSpinner(false);
      };
      reader.readAsText(file);
    }

    function processTranscript(text) {
      console.time('processTranscript');
      const contributions = parseTranscript(text);
      console.log('Parsed contributions:', contributions.length);
      const analysis = analyzeContributions(contributions);
      console.log('Analysis complete:', analysis.summary);
      currentAnalysis = analysis;
      currentContributions = contributions;
      saveHistoricalData(analysis);
      displayResults(analysis, contributions);
      console.timeEnd('processTranscript');
    }

    function analyzeText() {
      const text = pasteInput.value.trim();
      if (!text) {
        showError('paste-error', 'Please paste a transcript.');
        return;
      }

      const analyzeButton = document.getElementById('analyze-text-btn');
      if (analyzeButton.disabled) return; // Prevent multiple clicks

      toggleSpinner(true);
      analyzeButton.disabled = true;

      setTimeout(() => {
        try {
          processTranscript(text);
          const resultsSection = document.getElementById('results-section');
          resultsSection.style.display = 'block'; // Ensure visibility before scroll

          setTimeout(() => {
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            showSuccess('Analysis Complete! Scroll down for results.');
          }, 100); // Delay scroll to ensure DOM updates
        } catch (error) {
          console.error('Error in analyzeText:', error);
          showError('paste-error', 'Analysis failed: ' + error.message);
        } finally {
          toggleSpinner(false);
          analyzeButton.disabled = false;
        }
      }, 0); // Push to next event loop
    }

    function parseTranscript(text) {
      const lines = text.trim().split('\n');
      const contributions = [];
      let lastSpeaker = null;
      let syntheticTimestamp = 0;

      lines.forEach((line, i) => {
        line = line.trim();
        if (!line) return;

        let speaker, content, timestampSec;
        const timestampMatch = line.match(/\[(\d+:\d+)\]\s*(.*?):\s*(.*)/);
        if (timestampMatch) {
          const [_, time, spkr, txt] = timestampMatch;
          const [min, sec] = time.split(':').map(Number);
          speaker = spkr.trim() || 'Unknown';
          content = txt.trim();
          timestampSec = isNaN(min) || isNaN(sec) ? syntheticTimestamp++ : min * 60 + sec;
        } else if (line.match(/^Speaker\s*\d*/i)) {
          speaker = line.match(/^Speaker\s*(\d*)/i)[0].trim();
          content = line.replace(/^Speaker\s*\d*\s*/i, '').trim();
          timestampSec = syntheticTimestamp++;
          if (speaker === 'Speaker' && lastSpeaker && content.length < 20 && contributions.length > 0) {
            contributions[contributions.length - 1].text += ' ' + content;
            return;
          }
        } else if (lastSpeaker && line.length < 20 && !line.match(/^[A-Z]/)) {
          contributions[contributions.length - 1].text += ' ' + line;
          return;
        } else {
          speaker = 'Unknown';
          content = line;
          timestampSec = syntheticTimestamp++;
          console.warn(`Line ${i + 1} lacks speaker or format, assigned as Unknown: ${line}`);
        }

        contributions.push({ speaker, text: content, lineNum: i + 1, timestampSec });
        lastSpeaker = speaker;
      });

      return contributions.filter(c => c.text.length > 0);
    }

    function analyzeContributions(contributions) {
      if (!contributions || !Array.isArray(contributions) || contributions.length === 0) {
        throw new Error('Invalid or empty contributions array. Please provide a valid transcript.');
      }

      const totalLines = contributions.length;
      const speakerStats = {};
      const wordFreq = {};
      const stressData = { low: 0, mid: 0, high: 0, moments: [] };
      const tomData = { insights: [], mindSyncScore: 0 };

      const thresholds = {
        dominance: Math.max(10, Math.min(90, parseInt(document.getElementById('dominance-threshold').value) || 40)),
        inclusion: Math.max(1, Math.min(20, parseInt(document.getElementById('inclusion-threshold').value) || 5)),
        groupthink: Math.max(2, Math.min(10, parseInt(document.getElementById('groupthink-threshold').value) || 3)),
        interrupt: Math.max(1, Math.min(10, parseInt(document.getElementById('interrupt-threshold').value) || 2))
      };

      const customRules = parseCustomRules();

      contributions.forEach((c, i) => {
        speakerStats[c.speaker] = speakerStats[c.speaker] || { count: 0, words: 0 };
        speakerStats[c.speaker].count += 1;
        const words = c.text.split(/\s+/).filter(w => w.length > 2);
        speakerStats[c.speaker].words += words.length;
        words.forEach(w => {
          if (w.length > 3) wordFreq[w.toLowerCase()] = (wordFreq[w.toLowerCase()] || 0) + 1;
        });

        let stressScore = 0;
        if (c.text === c.text.toUpperCase() && c.text.length > 3) stressScore += 2;
        if (c.text.match(/!/g)) stressScore += (c.text.match(/!/g).length * 0.5);
        if (c.text.length < 10) stressScore += 1;
        if (i > 0 && c.speaker !== contributions[i-1].speaker && (c.timestampSec - contributions[i-1].timestampSec) <= 1) stressScore += 1;

        let stressLevel = 'none';
        if (stressScore >= 3) {
          stressLevel = 'high';
          stressData.high++;
        } else if (stressScore >= 1.5) {
          stressLevel = 'mid';
          stressData.mid++;
        } else if (stressScore > 0) {
          stressLevel = 'low';
          stressData.low++;
        }
        if (stressLevel !== 'none') stressData.moments.push({ lineNum: c.lineNum, level: stressLevel, score: stressScore });
      });

      let tomScore = 0;
      let tomInstances = 0;
      contributions.forEach((c, i) => {
        const textLower = c.text.toLowerCase();
        const prevText = i > 0 ? contributions[i-1].text.toLowerCase() : '';
        const prevSpeaker = i > 0 ? contributions[i-1].speaker : null;

        if (textLower.match(/\b(you|your|we|us|agree|understand|feel|think)\b/)) {
          tomScore += 1;
          tomInstances++;
          tomData.insights.push({ lineNum: c.lineNum, message: `${c.speaker} shows perspective-taking: "${c.text}"`, tip: 'Encourage this empathy!' });
        }
        if (i > 0 && prevSpeaker !== c.speaker && (textLower.includes(prevText.split(' ')[0]) || textLower.includes('yes') || textLower.includes('no'))) {
          tomScore += 1.5;
          tomInstances++;
          tomData.insights.push({ lineNum: c.lineNum, message: `${c.speaker} responds to ${prevSpeaker}: "${c.text}"`, tip: 'Good intent recognition—keep listening.' });
        }
        if (textLower.match(/\b(sorry|thanks|please|help)\b/)) {
          tomScore += 1;
          tomInstances++;
          tomData.insights.push({ lineNum: c.lineNum, message: `${c.speaker} expresses social awareness: "${c.text}"`, tip: 'Reinforce this kindness.' });
        }
        if (stressData.moments.some(m => m.lineNum === c.lineNum) && i > 0 && prevSpeaker !== c.speaker && textLower.match(/\b(calm|okay|relax)\b/)) {
          tomScore += 2;
          tomInstances++;
          tomData.insights.push({ lineNum: c.lineNum, message: `${c.speaker} de-escalates stress: "${c.text}"`, tip: 'Great emotional attunement!' });
        }
      });
      tomData.mindSyncScore = tomInstances ? Math.min(100, Math.round(tomScore / totalLines * 50)) : 50;

      const flags = [];
      for (const [speaker, stats] of Object.entries(speakerStats)) {
        const percent = (stats.count / totalLines) * 100;
        if (percent > thresholds.dominance) {
          flags.push({ type: 'Dominance', message: `${speaker} dominated (${Math.round(percent)}%).`, tip: 'Pause for others.', summary: true });
          tomData.insights.push({ lineNum: null, message: `${speaker} may not be reading the room.`, tip: 'Check in with quieter members.' });
        }
        if (percent < thresholds.inclusion && totalLines > 10) {
          flags.push({ type: 'Inclusion', message: `${speaker} under-contributed (${Math.round(percent)}%).`, tip: `Invite ${speaker}.`, summary: true });
          tomData.insights.push({ lineNum: null, message: `${speaker} might feel unheard.`, tip: `Ask ${speaker} for their thoughts.` });
        }
      }

      let agreementCount = 0;
      contributions.forEach((c, i) => {
        const textLower = c.text.toLowerCase();
        if (textLower.includes('agree') || textLower.includes('same')) {
          agreementCount++;
          if (agreementCount > thresholds.groupthink) flags.push({ type: 'Groupthink', message: `Line ${c.lineNum}: Too much agreement.`, tip: 'Seek diverse views.', line: c.lineNum });
        }
        if (textLower.match(/\b(never|always|waste)\b/) || (window.nlp && window.nlp(c.text).sentences().isNegative().out('array').length > 0)) {
          flags.push({ type: 'Tone', message: `Line ${c.lineNum}: Negative tone.`, tip: 'Rephrase positively.', line: c.lineNum });
          tomData.insights.push({ lineNum: c.lineNum, message: `${c.speaker} may be frustrated: "${c.text}"`, tip: 'Acknowledge their feelings.' });
        }
        if (i > 0 && (c.timestampSec - contributions[i-1].timestampSec) <= thresholds.interrupt && c.speaker !== contributions[i-1].speaker) {
          flags.push({ type: 'Interruption', message: `Line ${c.lineNum}: Possible interruption of ${contributions[i-1].speaker}.`, tip: 'Let others finish.', line: c.lineNum });
          tomData.insights.push({ lineNum: c.lineNum, message: `${c.speaker} might not sense ${contributions[i-1].speaker}’s need to speak.`, tip: 'Pause before jumping in.' });
        }
        customRules.forEach(rule => {
          const regex = rule.keyword.startsWith('/') ? new RegExp(rule.keyword.slice(1, -1), 'i') : new RegExp(`\\b${rule.keyword}\\b`, 'i');
          if (regex.test(textLower)) flags.push({ type: `Custom (${rule.severity})`, message: `Line ${c.lineNum}: ${rule.message}`, tip: 'Review this.', line: c.lineNum });
        });
      });

      const turnTaking = contributions.slice(1).filter((c, i) => c.speaker !== contributions[i].speaker).length / (totalLines - 1) || 0;
      const interruptions = flags.filter(f => f.type === 'Interruption').length;
      const maxContributionPercentage = (Math.max(...Object.values(speakerStats).map(s => s.count)) / totalLines) * 100;
      const balance = Math.min(100, Math.max(0, 100 - (maxContributionPercentage - thresholds.dominance)));
      const stressImpact = 100 - ((stressData.low * 0.5 + stressData.mid * 1 + stressData.high * 2) / totalLines * 10);
      const engagementDiversity = calculateEngagementDiversity(speakerStats, totalLines);
      const mindSync = tomData.mindSyncScore;
      const teamHarmonyScore = Math.round((turnTaking * 20 + (100 - interruptions * 5) * 20 + balance * 20 + stressImpact * 15 + engagementDiversity * 15 + mindSync * 10) / 100);

      const collabMetrics = {
        turnTaking,
        interruptions,
        balance,
        stressImpact,
        engagementDiversity,
        mindSync,
        teamHarmonyScore
      };

      const lang = window.franc ? franc(contributions.map(c => c.text).join(' '), { minLength: 10 }) === 'spa' ? 'Spanish' : 'English' : 'Unknown (language detection unavailable)';
      const summary = `${flags.filter(f => f.summary).map(f => f.message).join(' ') || 'No major biases.'} | Language: ${lang} | Stressful moments: ${stressData.low + stressData.mid + stressData.high} | Team Harmony: ${teamHarmonyScore}/100 | MindSync: ${mindSync}/100`;
      return { summary, flags, speakerStats, wordFreq, collabMetrics, stressData, tomData, text: contributions.map(c => c.text).join(' ') };
    }

    function calculateEngagementDiversity(speakerStats, totalLines) {
      const contributions = Object.values(speakerStats).map(s => s.count / totalLines);
      const mean = contributions.reduce((a, b) => a + b, 0) / contributions.length;
      const variance = contributions.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / contributions.length;
      return Math.min(100, Math.round(100 - variance * 1000));
    }

    function parseCustomRules() {
      const rulesText = document.getElementById('custom-rules').value.trim();
      if (!rulesText) return [];
      return rulesText.split('\n').map(line => {
        try {
          const [keySeverity, message] = line.split('=').map(s => s.trim());
          const [keyword, severity] = keySeverity.split(':');
          return { keyword, severity: severity || 'warning', message: message || 'Custom flag detected' };
        } catch (error) {
          console.warn('Invalid custom rule:', line, error);
          return null;
        }
      }).filter(rule => rule);
    }

    function displayResults(analysis, contributions) {
      console.log('Displaying results:', analysis);
      document.getElementById('results-section').style.display = 'block';
      document.getElementById('summary').innerHTML = analysis.summary;

      let transcriptHTML = '';
      contributions.forEach(c => {
        const lineFlags = analysis.flags.filter(f => f.line === c.lineNum);
        const stressMoment = analysis.stressData.moments.find(m => m.lineNum === c.lineNum);
        const tomInsight = analysis.tomData.insights.find(t => t.lineNum === c.lineNum);
        const stressClass = stressMoment ? `stress-${stressMoment.level}` : '';
        const flagText = lineFlags.length ? `<span class="flag">[${lineFlags.map(f => `${f.message} <span class="tip">(${f.tip})</span>`).join('; ')}]</span>` : '';
        const stressText = stressMoment ? ` <span class="flag">[Stress: ${stressMoment.level} (score: ${stressMoment.score.toFixed(1)})]</span>` : '';
        const tomText = tomInsight ? ` <span class="tip">[ToM: ${tomInsight.message}]</span>` : '';
        transcriptHTML += `<div class="transcript-line ${stressClass}" data-stress="${stressMoment ? stressMoment.level : 'none'}" onmouseover="playStressSound(this)">[${formatTime(c.timestampSec)}] ${c.speaker}: ${c.text}${flagText}${stressText}${tomText}</div>`;
      });
      document.getElementById('annotated-transcript').innerHTML = transcriptHTML;

      displayStressStats(analysis.stressData);
      drawKeywordCloud(analysis.wordFreq);
      displayCollabMetrics(analysis.collabMetrics);
      displayToMInsights(analysis.tomData);
      displayLanguageDetection(analysis.text);
      displayHistoricalComparison(analysis);
    }

    function playStressSound(element) {
      const stressLevel = element.getAttribute('data-stress');
      if (stressLevel !== 'none' && stressSounds[stressLevel]) {
        stressSounds[stressLevel].currentTime = 0;
        stressSounds[stressLevel].play().catch(e => console.warn('Audio playback failed:', e));
      }
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function displayStressStats(stressData) {
      const total = stressData.low + stressData.mid + stressData.high;
      document.getElementById('stress-stats').innerHTML = `
        Stressful Moments: ${total}<br>
        Low (calm tension): ${stressData.low} (${total ? Math.round(stressData.low / total * 100) : 0}%)
        <div class="progress-bar"><div class="progress-fill low" style="width: ${total ? (stressData.low / total * 100) : 0}%"></div></div>
        Medium (raised voices): ${stressData.mid} (${total ? Math.round(stressData.mid / total * 100) : 0}%)
        <div class="progress-bar"><div class="progress-fill mid" style="width: ${total ? (stressData.mid / total * 100) : 0}%"></div></div>
        High (heated): ${stressData.high} (${total ? Math.round(stressData.high / total * 100) : 0}%)
        <div class="progress-bar"><div class="progress-fill high" style="width: ${total ? (stressData.high / total * 100) : 0}%"></div></div>
        <small>Hover over stressed lines for sound effects!</small>
      `;
    }

    function drawKeywordCloud(wordFreq) {
      const topWords = Object.entries(wordFreq).sort((a, b) => b[1] - a[1]).slice(0, 10);
      document.getElementById('keyword-cloud').innerHTML = topWords.map(([word, freq]) => `<span style="font-size: ${Math.min(30, 12 + freq * 3)}px" title="${freq} occurrences">${word}</span>`).join('');
    }

    function displayCollabMetrics(metrics) {
      document.getElementById('collab-metrics').innerHTML = `
        <strong>Team Harmony Score: ${metrics.teamHarmonyScore}/100</strong>
        <div class="progress-bar"><div class="progress-fill low" style="width: ${metrics.teamHarmonyScore}%"></div></div>
        Turn-taking: ${(metrics.turnTaking * 100).toFixed(1)}%
        <div class="progress-bar"><div class="progress-fill low" style="width: ${metrics.turnTaking * 100}%"></div></div>
        Interruptions: ${metrics.interruptions}<br>
        Speaker Balance: ${metrics.balance.toFixed(1)}/100
        <div class="progress-bar"><div class="progress-fill low" style="width: ${metrics.balance}%"></div></div>
        Stress Impact: ${metrics.stressImpact.toFixed(1)}/100
        <div class="progress-bar"><div class="progress-fill low" style="width: ${metrics.stressImpact}%"></div></div>
        Engagement Diversity: ${metrics.engagementDiversity.toFixed(1)}/100
        <div class="progress-bar"><div class="progress-fill low" style="width: ${metrics.engagementDiversity}%"></div></div>
        MindSync Index: ${metrics.mindSync}/100
        <div class="progress-bar"><div class="progress-fill low" style="width: ${metrics.mindSync}%"></div></div>
      `;
      if (window.Chart) drawRadarChart(metrics);
      else console.warn('Chart.js not loaded, skipping radar chart.');
    }

    function drawRadarChart(metrics) {
      if (radarChart) radarChart.destroy();
      const ctx = document.getElementById('radar-chart').getContext('2d');
      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Turn-taking', 'Interruptions', 'Balance', 'Stress Impact', 'Engagement', 'MindSync'],
          datasets: [{
            label: 'Collaboration Profile',
            data: [
              metrics.turnTaking * 100,
              Math.max(0, 100 - metrics.interruptions * 10),
              metrics.balance,
              metrics.stressImpact,
              metrics.engagementDiversity,
              metrics.mindSync
            ],
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 20, color: document.body.classList.contains('dark') ? '#ecf0f1' : '#333' },
              grid: { color: document.body.classList.contains('dark') ? '#5d6d7e' : '#ddd' },
              pointLabels: { color: document.body.classList.contains('dark') ? '#ecf0f1' : '#333' }
            }
          },
          plugins: {
            legend: { position: 'top', labels: { color: document.body.classList.contains('dark') ? '#ecf0f1' : '#333' } }
          }
        }
      });
    }

    function displayToMInsights(tomData) {
      const insightsHTML = tomData.insights.length 
        ? tomData.insights.map(t => `${t.lineNum ? `Line ${t.lineNum}: ` : ''}${t.message} <span class="tip">(${t.tip})</span>`).join('<br>')
        : 'No clear Theory of Mind cues detected—team may need to connect more.';
      document.getElementById('tom-insights').innerHTML = `
        <strong>MindSync Index: ${tomData.mindSyncScore}/100</strong>
        <div class="progress-bar"><div class="progress-fill low" style="width: ${tomData.mindSyncScore}%"></div></div>
        ${insightsHTML}
      `;
    }

    function displayLanguageDetection(text) {
      const lang = window.franc ? franc(text, { minLength: 10 }) === 'spa' ? 'Spanish' : 'English' : 'Unknown (language detection unavailable)';
      const mockTranslation = lang === 'Spanish' ? text.replace(/el/g, 'the').substring(0, 50) + '...' : 'No translation needed.';
      document.getElementById('language-detection').innerHTML = `Detected: ${lang}<br>Translation (mock): ${mockTranslation}<br><small>For full translation, integrate an API.</small>`;
    }

    function saveHistoricalData(analysis) {
      let history;
      try {
        const stored = localStorage.getItem('equivoice_history');
        history = stored ? JSON.parse(stored) : [];
        if (!Array.isArray(history)) {
          console.warn('Stored history is not an array, resetting.');
          history = [];
        }
      } catch (error) {
        console.error('Error parsing historical data:', error);
        history = [];
      }

      history.push({
        timestamp: new Date().toISOString(),
        summary: analysis.summary,
        dominance: analysis.flags.some(f => f.type === 'Dominance'),
        balance: analysis.collabMetrics.balance,
        stressMoments: analysis.stressData.low + analysis.stressData.mid + analysis.stressData.high,
        teamHarmonyScore: analysis.collabMetrics.teamHarmonyScore,
        mindSyncScore: analysis.collabMetrics.mindSync
      });

      if (history.length > 5) history.shift();
      try {
        localStorage.setItem('equivoice_history', JSON.stringify(history));
      } catch (error) {
        console.error('Error saving historical data:', error);
      }
    }

    function displayHistoricalComparison(analysis) {
      let history;
      try {
        history = JSON.parse(localStorage.getItem('equivoice_history') || '[]');
        if (!Array.isArray(history)) throw new Error('History is not an array');
      } catch (error) {
        console.error('Error retrieving historical data:', error);
        document.getElementById('historical-comparison').innerHTML = 'Error loading historical data.';
        return;
      }

      if (history.length < 2) {
        document.getElementById('historical-comparison').innerHTML = 'Not enough data for comparison.';
        return;
      }
      const avgBalance = history.slice(0, -1).reduce((sum, h) => sum + h.balance, 0) / (history.length - 1);
      const avgStress = history.slice(0, -1).reduce((sum, h) => sum + (h.stressMoments || 0), 0) / (history.length - 1);
      const avgHarmony = history.slice(0, -1).reduce((sum, h) => sum + (h.teamHarmonyScore || 0), 0) / (history.length - 1);
      const avgMindSync = history.slice(0, -1).reduce((sum, h) => sum + (h.mindSyncScore || 0), 0) / (history.length - 1);
      const dominanceTrend = history.slice(0, -1).filter(h => h.dominance).length / (history.length - 1) > 0.5 ? 'more' : 'less';
      document.getElementById('historical-comparison').innerHTML = `Compared to ${history.length - 1} past analyses:<br>
        Avg. Balance: ${avgBalance.toFixed(1)} (Current: ${analysis.collabMetrics.balance.toFixed(1)})<br>
        Avg. Stress Moments: ${avgStress.toFixed(1)} (Current: ${analysis.stressData.low + analysis.stressData.mid + analysis.stressData.high})<br>
        Avg. Team Harmony: ${avgHarmony.toFixed(1)} (Current: ${analysis.collabMetrics.teamHarmonyScore})<br>
        Avg. MindSync: ${avgMindSync.toFixed(1)} (Current: ${analysis.collabMetrics.mindSync})<br>
        Dominance: ${dominanceTrend} frequent than past`;
      if (window.Chart) drawHistoryChart(history);
    }

    function drawHistoryChart(history) {
      if (historyChart) historyChart.destroy();
      const ctx = document.getElementById('history-chart').getContext('2d');
      const labels = history.map(h => new Date(h.timestamp).toLocaleDateString());
      const harmonyData = history.map(h => h.teamHarmonyScore);
      const mindSyncData = history.map(h => h.mindSyncScore);
      historyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Team Harmony',
              data: harmonyData,
              backgroundColor: 'rgba(52, 152, 219, 0.6)',
              borderColor: 'rgba(52, 152, 219, 1)',
              borderWidth: 1
            },
            {
              label: 'MindSync',
              data: mindSyncData,
              backgroundColor: 'rgba(46, 204, 113, 0.6)',
              borderColor: 'rgba(46, 204, 113, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { color: document.body.classList.contains('dark') ? '#ecf0f1' : '#333' },
              grid: { color: document.body.classList.contains('dark') ? '#5d6d7e' : '#ddd' }
            },
            x: {
              ticks: { color: document.body.classList.contains('dark') ? '#ecf0f1' : '#333' },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { position: 'top', labels: { color: document.body.classList.contains('dark') ? '#ecf0f1' : '#333' } }
          }
        }
      });
    }

    function updateChartColors() {
      if (radarChart) {
        radarChart.options.scales.r.ticks.color = document.body.classList.contains('dark') ? '#ecf0f1' : '#333';
        radarChart.options.scales.r.grid.color = document.body.classList.contains('dark') ? '#5d6d7e' : '#ddd';
        radarChart.options.scales.r.pointLabels.color = document.body.classList.contains('dark') ? '#ecf0f1' : '#333';
        radarChart.options.plugins.legend.labels.color = document.body.classList.contains('dark') ? '#ecf0f1' : '#333';
        radarChart.update();
      }
      if (historyChart) {
        historyChart.options.scales.y.ticks.color = document.body.classList.contains('dark') ? '#ecf0f1' : '#333';
        historyChart.options.scales.y.grid.color = document.body.classList.contains('dark') ? '#5d6d7e' : '#ddd';
        historyChart.options.scales.x.ticks.color = document.body.classList.contains('dark') ? '#ecf0f1' : '#333';
        historyChart.options.plugins.legend.labels.color = document.body.classList.contains('dark') ? '#ecf0f1' : '#333';
        historyChart.update();
      }
    }

    function exportResults() {
      if (!currentAnalysis || !currentContributions) return alert('No results to export.');
      const { summary, flags, stressData, collabMetrics, tomData } = currentAnalysis;
      let exportText = `EquiVoice Analysis\n\nSummary: ${summary}\nTeam Harmony Score: ${collabMetrics.teamHarmonyScore}/100\nMindSync Index: ${collabMetrics.mindSync}/100\n\nTranscript:\n`;
      currentContributions.forEach(c => {
        const lineFlags = flags.filter(f => f.line === c.lineNum);
        const stressMoment = stressData.moments.find(m => m.lineNum === c.lineNum);
        const tomInsight = tomData.insights.find(t => t.lineNum === c.lineNum);
        const flagText = lineFlags.length ? ` [${lineFlags.map(f => `${f.message} (${f.tip})`).join('; ')}]` : '';
        const stressText = stressMoment ? ` [Stress: ${stressMoment.level} (score: ${stressMoment.score.toFixed(1)})]` : '';
        const tomText = tomInsight ? ` [ToM: ${tomInsight.message} (${tomInsight.tip})]` : '';
        exportText += `[${formatTime(c.timestampSec)}] ${c.speaker}: ${c.text}${flagText}${stressText}${tomText}\n`;
      });
      const blob = new Blob([exportText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'EquiVoice_Analysis.txt';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>